---
title: JVM
layout: page
date: 2016-03-17
---
[TOC]

## 内存模型
![内存模型](http://7xjtfr.com1.z0.glb.clouddn.com/41376821593549120.jpg)

1. 程序计数器（线程私有）

    当前线程所执行的字节码的行号指示器。

2. 栈（线程私有）

    每个方法执行时会创建一个栈帧用于存储局部变量等信息。

3. 本地方法栈（类似栈）

    为虚拟机使用到的 Native 方法服务。

4. 堆（线程共享）

    存放对象实例，是垃圾收集器管理的主要区域。

5. 方法区（线程共享）

    用于存储已经被虚拟机加载的类信息，常量，静态变量，即时编译器编译后的代码等数据。（也被人称为“永久代”）
    运行时常量池位于这个区域，用于存放编译期生成的各种字面量和符号引用。

## 垃圾回收

### 回收的对象
堆中的对象
#### 可达性分析算法
从 GC Roots 出发，没有跟 GC Roots 引用链相连的对象可回收。

#### GC Roots 选择
1. 栈中引用的对象
2. 方法区（永久代）中引用的对象
3. 本地方法栈中引用的对象

#### 引用

1. **强引用**：不会被回收
2. **软引用**：内存不足时才会被回收
3. **弱引用**：只能生存到下一次垃圾收集发生之前
4. **虚引用**：被回收时能收到一个系统通知

### 回收的方法

#### 标记清除算法
标记需要回收的对象，标记完成之后清除被标记对象。

缺点：效率低，空间碎片
#### 复制算法
把内存空间分为两块，只使用其中的一块，满了之后把存活的对象复制到另一块，清除本块的对象。

缺点：存活率大时需要较多复制操作。

#### 标记整理算法
标记回收对象之后，把它们移动到一端，清除端边界外的对象。

#### 分代收集算法
把堆分为两块：

1. **新生代**：使用复制算法。（包括一个Eden空间和两个survivor空间）
2. **老年代**：使用标记清除或标记整理算法。

### 垃圾收集器
![垃圾收集器](http://7xjtfr.com1.z0.glb.clouddn.com/20130925212623125.jpg)

1. Serial: 单线程收集器，工作时暂停其他工作线程。常用于Client模式，在新生代采用复制算法，在老生代使用标记-整理算法
2. ParNew: Serial 多线程版本，并行收集器，主要用于新生代收集。与CMS收集器配合成为现在最常用的server收集器
3. Parallel Scavenge 并行收集器，吞吐量（用户代码运行时间/用户代码运行时间+垃圾收集时间）优先。
4. Serial Old: Serial 老年代版本，单线程，使用“标记整理”算法
5. Parallel Old: Parallel Scavenge 的老年代版本。
6. CMS: 并发收集，低停顿，基于“标记-清除”算法。

    1. 初始标记: 暂停工作线程，标记 GC Roots 能直接关联到的对象。
    2. 并发标记：与工作线程并发，进行 GC Roots Tracing
    3. 重新标记：暂停工作线程，修正并发标记过程中发生变动的对象。
    4. 并发清除

    缺点：

    1. 对CPU资源非常敏感
    2. 不能处理浮动垃圾（标记过程后出现的垃圾）
    3. 产生空间碎片

7. G1（Garbage First)

    特点：

    1. 并行与并发
    2. 分代收集（概念上分代，实际的内存布局不再是新生代，老年代隔离）
    3. 空间整合（基于“标记整理”算法）
    4. 可预测的停顿
    5. 分 Region 收集，根据允许收集的时间，优先回收价值最大的 Region

    过程：

    1. 初始标记
    2. 并发标记
    3. 最终标记：并行
    4. 筛选回收：并行

## 内存分配
- 新生代GC（Minor GC）：发生在新生代的垃圾收集，速度比较块。
- 老年代GC （Major GC/Full GC）：发生在老年代的垃圾收集，速度比较慢。

### 内存分配策略

1. 对象优先在Eden分配
2. 大对象直接进入老年代
3. 长期存活的对象将进入老年代：对象年龄达到设定值
4. 动态对象年龄判定：如果Survivor空间中相同年龄所有对象的大小总和大于Survivor空间的一半，大于等于该年龄的对象进入老年代
5. 空间分配担保：发生Minor GC之前，虚拟机会检查老年代的可用空间是否大于新生代所有对象的空间，条件成立则Minor GC是安全的

### 内存布局
![内存布局](http://7xjtfr.com1.z0.glb.clouddn.com/06524e23ef9136970be290e3732c0066_thumb.jpg)