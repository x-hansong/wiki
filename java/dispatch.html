<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Java 分派（重载与重写） - Wiki | HanSong</title>
    <meta name="keywords" content="wiki, markdown, linux, c, java, python, qemu"/>
    <meta name="description" content="HanSong's personal wiki, recording my little thoughts"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#java">java</a>&nbsp;&#187;&nbsp;Java 分派（重载与重写）
    <span class="updated">Updated&nbsp;
      2016-04-20
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Java 分派（重载与重写）</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">方法调用指令</a></li>
<li><a href="#_2">重载与重写</a></li>
<li><a href="#_3">静态分派</a></li>
<li><a href="#_4">动态分派</a></li>
</ul>
</div>
<h2 id="_1">方法调用指令</h2>
<ol>
<li><strong>invokevirtual</strong>：用于调用对象的实例方法，根据对象的实际类型进行分派，最常见的方法分派方式。</li>
<li><strong>invokeinterface</strong>：用于调用接口方法，他会在运行时搜索一个实现了该接口方法的对象，找出合适的方法进行调用。</li>
<li><strong>invokespecial</strong>：用于调用一些需要特殊处理的实例方法，包括实例 初始化方法，私有方法和父类方法。</li>
<li><strong>invokestatic</strong>：用于调用类方法（static方法）。</li>
<li><strong>invokedynamic</strong>：用于运行时动态解析出调用点限定符所引用的方法。前面四条指令的分派逻辑是固化在 JVM 中的，而该指令的分派逻辑是由用户设定的引导方法决定的。</li>
</ol>
<h2 id="_2">重载与重写</h2>
<p>方法重载（overload）：</p>
<ol>
<li>必须是同一个类</li>
<li>方法名（也可以叫函数）一样</li>
<li>参数类型不一样或参数数量不一样</li>
</ol>
<p>方法的重写（override）两同两小一大原则：</p>
<ol>
<li>方法名相同，参数类型相同</li>
<li>子类返回类型小于等于父类方法返回类型，</li>
<li>子类抛出异常小于等于父类方法抛出异常，</li>
<li>子类访问权限大于等于父类方法访问权限。</li>
</ol>
<h2 id="_3">静态分派</h2>
<div class="hlcode"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">StaticDispatch</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">abstract</span> <span class="n">class</span> <span class="n">Human</span><span class="p">{</span>

    <span class="p">}</span>

    <span class="k">static</span> <span class="n">class</span> <span class="n">Man</span> <span class="n">extends</span> <span class="n">Human</span><span class="p">{</span>

    <span class="p">}</span>

    <span class="k">static</span> <span class="n">class</span> <span class="n">Woman</span> <span class="n">extends</span> <span class="n">Human</span><span class="p">{</span>

    <span class="p">}</span>
    <span class="n">public</span> <span class="kt">void</span> <span class="n">sayHello</span> <span class="p">(</span><span class="n">Human</span> <span class="n">guy</span><span class="p">){</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;hello, guy&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="kt">void</span> <span class="n">sayHello</span><span class="p">(</span><span class="n">Man</span> <span class="n">guy</span><span class="p">){</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;hello, gentleman&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="kt">void</span> <span class="n">sayHello</span><span class="p">(</span><span class="n">Woman</span> <span class="n">guy</span><span class="p">){</span>
        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;hello, lady&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">){</span>
        <span class="n">Human</span> <span class="n">man</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Man</span><span class="p">();</span>
        <span class="n">Human</span> <span class="n">woman</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Woman</span><span class="p">();</span>
        <span class="n">StaticDispatch</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">StaticDispatch</span><span class="p">();</span>
        <span class="n">sr</span><span class="p">.</span><span class="n">sayHello</span><span class="p">(</span><span class="n">man</span><span class="p">);</span>
        <span class="n">sr</span><span class="p">.</span><span class="n">sayHello</span><span class="p">(</span><span class="n">woman</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">运行结果是：</span>

<span class="n">hello</span><span class="p">,</span> <span class="n">guy</span>
<span class="n">hello</span><span class="p">,</span> <span class="n">guy</span>
</pre></div>


<p>上面代码中 "Human" 称为变量的静态类型，后面的 "Man" 称为实际类型。静态类型在编译期是已知的，而实际类型在运行期才确定。编译器在重载时是通过参数的静态类型决定使用哪个重载版本。所以编译器在编译阶段，选择了 <code>sayHello(Human)</code>作为调用目标。</p>
<p>所有依赖静态类型来定位方法执行版本的分派动作称为静态分派。静态分派的典型应用是方法重载。静态分派发生在编译阶段。由于字面量没有显式的静态类型，他的静态类型只能通过语言上的规则去理解和推断。</p>
<h2 id="_4">动态分派</h2>
<div class="hlcode"><pre><span class="n">public</span> <span class="n">class</span> <span class="n">DynamicDispatch</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">abstract</span> <span class="n">class</span> <span class="n">Human</span><span class="p">{</span>
        <span class="n">protected</span> <span class="n">abstract</span> <span class="kt">void</span> <span class="n">sayHello</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">class</span> <span class="n">Man</span> <span class="n">extends</span> <span class="n">Human</span><span class="p">{</span>

        <span class="err">@</span><span class="n">Override</span>
        <span class="n">protected</span> <span class="kt">void</span> <span class="n">sayHello</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;man say hello&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">class</span> <span class="n">Woman</span> <span class="n">extends</span> <span class="n">Human</span><span class="p">{</span>

        <span class="err">@</span><span class="n">Override</span>
        <span class="n">protected</span> <span class="kt">void</span> <span class="n">sayHello</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;woman say hello&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">){</span>
        <span class="n">Human</span> <span class="n">man</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Man</span><span class="p">();</span>
        <span class="n">Human</span> <span class="n">woman</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Woman</span><span class="p">();</span>
        <span class="n">man</span><span class="p">.</span><span class="n">sayHello</span><span class="p">();</span>
        <span class="n">woman</span><span class="p">.</span><span class="n">sayHello</span><span class="p">();</span>
        <span class="n">man</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Woman</span><span class="p">();</span>
        <span class="n">man</span><span class="p">.</span><span class="n">sayHello</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">运行结果</span>
<span class="n">man</span> <span class="n">say</span> <span class="n">hello</span>
<span class="n">woman</span> <span class="n">say</span> <span class="n">hello</span>
<span class="n">woman</span> <span class="n">say</span> <span class="n">hello</span>
</pre></div>


<p>上面代码是典型的多态，从字节码中可以看到，每个<code>sayHello()</code>方法都是用<code>invokevirtual</code>指令调用的，后面的符号引用也是一样的，但是执行的结果却是不同的。</p>
<div class="hlcode"><pre><span class="n">INVOKEVIRTUAL</span> <span class="n">com</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">DynamicDispatch</span><span class="err">$</span><span class="n">Human</span><span class="p">.</span><span class="n">sayHello</span> <span class="p">()</span><span class="n">V</span>
</pre></div>


<p>原因就要从 <code>invokevirtual</code>指令的多态查找过程开始说起：</p>
<ol>
<li>找到操作数栈顶的第一个元素所指向的对象的实际类型，记作C。</li>
<li>如果在类型C中找到与常量描述符和简单名称都相符的方法，则进行访问权限校验，如果通过则返回该方法的直接引用，查找过程结束；如果不通过，则返回<code>java.lang.IllegalAccessError</code>异常。</li>
<li>否则，按照继承关系从下往上依次对C的各个父类进行第2步的搜索和验证过程。</li>
<li>如果始终没有找到合适的方法，则抛出<code>java.lang.AbstractMethodError</code>异常。</li>
</ol>
<p>由于<code>invokevirtual</code>执行的第一步就是在运行期确定接受者的实际类型，所以调用中的<code>invokevirtual</code>指令把常量池中的类方法符号引用解析到了不同的直接引用上，这个过程就是方法重写的本质。</p>
<p>这种在运行期根据实际类型确定方法执行版本的分派过程称为动态分派。</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2016 HanSong Xiao.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256629854'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1256629854%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script></p>
        <p>Site Generated 2016-08-14 22:28:15</p>
      </span>
    </div>
  </body>
</html>